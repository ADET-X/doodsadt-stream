<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Streaming - Index</title>
  <link rel="stylesheet" href="style.css" />
  <script src="data.js"></script> <!-- harus sebelum script utama -->
</head>
<body>
  <div class="container">
    <header><h1>Video Streaming</h1></header>
    <main id="video-list" class="grid" aria-live="polite"></main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const listEl = document.getElementById('video-list');

    // defensive: cek data.js
    if (!window.videos || !Array.isArray(window.videos)){
      listEl.innerHTML = '<div style="padding:20px;color:#f88">Error: data.js tidak ter-load atau variabel `videos` tidak tersedia.</div>';
      console.error('data.js tidak ter-load atau variabel videos tidak ada.');
      return;
    }

    // hosts chain untuk thumbnail: primary -> fallback -> placeholder
    const thumbHosts = ['https://dsimgcdn.com/splash/', 'https://img.doodcdn.co/splash/'];
    const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" fill="#999" font-size="20" font-family="Arial" text-anchor="middle" dy=".3em">No Preview</text></svg>');

    function makeCard(v){
      const card = document.createElement('div');
      card.className = 'card';

      const a = document.createElement('a');
      a.href = `player.html?id=${encodeURIComponent(v.id)}`;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const img = document.createElement('img');
      img.alt = v.title || 'thumbnail';
      img.loading = 'lazy';
      img.src = `${thumbHosts[0]}${v.id}.jpg`;

      // fallback chain
      img.onerror = function(){
        this.onerror = null;
        this.src = `${thumbHosts[1]}${v.id}.jpg`;
        this.onerror = function(){ this.onerror = null; this.src = placeholder; };
      };

      const dur = document.createElement('span');
      dur.className = 'duration';
      dur.textContent = v.duration || '';

      thumb.appendChild(img);
      thumb.appendChild(dur);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<div class="title">${(v.title||'Untitled')}</div><div class="sub">${v.duration ? '' : ''}</div>`;

      a.appendChild(thumb);
      a.appendChild(meta);
      card.appendChild(a);
      return card;
    }

    // render
    videos.forEach(v => {
      try{ listEl.appendChild(makeCard(v)); } catch(err){ console.error('render card error', err, v); }
    });

    // debug helper: check thumbnails in console => checkThumbnails()
    window.checkThumbnails = function(){
      const results = [];
      let pending = videos.length;
      videos.forEach(v => {
        const img = new Image();
        img.onload = function(){ results.push({id:v.id, ok:true}); if(--pending===0) console.table(results); };
        img.onerror = function(){ results.push({id:v.id, ok:false}); if(--pending===0) console.table(results); };
        img.src = `${thumbHosts[0]}${v.id}.jpg?_=${Date.now()}`;
      });
    };
  });
  </script>
</body>
</html>
